<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>anketbox - 回答</title>
  <link rel="stylesheet" href="style.css">
  <meta name="color-scheme" content="light dark">
</head>
<body>
  <header class="app-header container">
    <div class="brand">
      <div class="logo">🗳️</div>
      <h1>回答</h1>
    </div>
    <a class="tab" href="./index.html">← トップへ</a>
  </header>
  <main class="container">
    <div class="card stack">
      <label>回答者名
        <input id="respondent" placeholder="任意"/>
      </label>
      <form id="answerForm"></form>
      <div class="row end">
        <button id="submitAnswerBtn" class="primary" type="button">回答を送信</button>
      </div>
    </div>
  </main>

  <script>
    "use strict";
    const STORAGE_SURVEY = "anketbox:survey";
    const STORAGE_RESPONSES = "anketbox:responses";
    const respondentInput = document.getElementById("respondent");
    const answerForm = document.getElementById("answerForm");
    const submitAnswerBtn = document.getElementById("submitAnswerBtn");

    function loadJson(key, fallback){ try{ const r=localStorage.getItem(key); return r?JSON.parse(r):fallback }catch{ return fallback } }
    function saveJson(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
    function create(tag, attrs={}, children=[]) { const el=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k==="text") el.textContent=v; else if(k==="className") el.className=v; else if(k.startsWith("on")&&typeof v==="function") el.addEventListener(k.slice(2).toLowerCase(), v); else if(v!==undefined && v!==null) el.setAttribute(k, String(v)); }); children.forEach(c=>el.appendChild(c)); return el; }

    function render() {
      const survey = loadJson(STORAGE_SURVEY, null);
      answerForm.innerHTML = "";
      if (!survey) {
        answerForm.appendChild(create("div", {text: "アンケート設計がありません。（トップから作成してください）"}));
        return;
      }
      survey.questions.forEach((q,i)=>{
        if(q.type==="single"||q.type==="multi"){
          const fs=create("fieldset");
          fs.appendChild(create("legend", {text: q.label + (q.required?" *":"")}));
          (q.options||[]).forEach(opt=>{
            fs.appendChild(create("label", {className:"inline"}, [
              create("input", {type: q.type==="single"?"radio":"checkbox", name: `q_${i}`, value: opt}),
              document.createTextNode(opt)
            ]));
          });
          answerForm.appendChild(fs);
        } else {
          const control = q.type==="textarea" ? create("textarea", {id:`q_${i}`}) : create("input", {id:`q_${i}`});
          if(q.required) control.setAttribute("required","true");
          answerForm.appendChild(create("label", {}, [document.createTextNode(q.label + (q.required?" *":"")), control]));
        }
      });
      attachAutoAdvance();
    }

    function attachAutoAdvance(){
      const blocks = Array.from(answerForm.children);
      function scrollToNext(fromEl){
        let next = fromEl.nextElementSibling;
        while(next && !(next.tagName === 'FIELDSET' || next.tagName === 'LABEL')){
          next = next.nextElementSibling;
        }
        if(next){
          next.scrollIntoView({ behavior: 'smooth', block: 'start' });
          const input = next.querySelector('input, textarea, select');
          if(input && input.focus) setTimeout(()=> input.focus(), 250);
        } else {
          // 最後なら送信ボタンへ
          setTimeout(()=> submitAnswerBtn.focus(), 200);
        }
      }
      // ラジオ選択で次へ
      answerForm.querySelectorAll('input[type="radio"]').forEach(r => {
        r.addEventListener('change', (e)=>{
          const group = e.target.closest('fieldset') || e.target.closest('label');
          if(group) scrollToNext(group);
        });
      });
      // テキスト/テキストエリアでEnter押下時に次へ（複数行はShift+Enterで改行）
      answerForm.querySelectorAll('input[type="text"], textarea').forEach(el => {
        el.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' && !(el.tagName === 'TEXTAREA' && e.shiftKey)){
            e.preventDefault();
            const holder = el.closest('label') || el;
            scrollToNext(holder);
          }
        });
      });
      // チェックボックスは明示操作が多いのでスキップ（必要なら変更で進むに変更可能）
    }

    submitAnswerBtn.addEventListener("click", ()=>{
      const survey = loadJson(STORAGE_SURVEY, null);
      if(!survey){ alert("アンケート設計がありません。"); return; }
      try{
        const answers = survey.questions.map((q,i)=>{
          if(q.type==="single"){
            const c = answerForm.querySelector(`input[name="q_${i}"]:checked`);
            const v = c?c.value:""; if(q.required && !v) throw new Error(`${q.label} は必須です`); return v;
          } else if(q.type==="multi"){
            const a = Array.from(answerForm.querySelectorAll(`input[name="q_${i}"]:checked`)).map(el=>el.value);
            if(q.required && a.length===0) throw new Error(`${q.label} は必須です`); return a.join(";");
          } else {
            const el = document.getElementById(`q_${i}`); const v = el?el.value:""; if(q.required && !v.trim()) throw new Error(`${q.label} は必須です`); return v;
          }
        });
        const rec = { respondent: respondentInput.value||"", answers, createdAt: Date.now() };
        const list = loadJson(STORAGE_RESPONSES, []); list.push(rec); saveJson(STORAGE_RESPONSES, list);
        alert("回答を保存しました。ありがとうございました。");
        answerForm.reset(); respondentInput.value="";
        // 保存後は一覧ページへ遷移
        setTimeout(()=>{ location.href = './list.html'; }, 300);
      } catch(e){ alert(e.message||String(e)); }
    });

    render();
  </script>
</body>
</html>

